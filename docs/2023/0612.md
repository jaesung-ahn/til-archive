# 0612

## [F-Lab 모각코 챌린지 2일차] JVM 메모리 구조(자바 7,8 기준)
JVM 메모리 구조를 자바 7, 8버전 을 기준으로 알아보자.

- Java 7 Hotspot JVM 구조
```
<---- Java Heap ------> < Permanent Heap > < Native Memory  >
+------+---+---+-------+------------------+--------+--------+
| Eden | S | S |  Old  |     Permanent    | C Heap | Thread |
|      | 0 | 1 |       |                  |        | Stack  |
+------+---+---+-------+------------------+--------+--------+
```
- Java 8 Hotspot JVM 구조
```
<---- Java Heap ------> <--------- Native Memory ---------->
+------+---+---+-------+------------------+--------+--------+
| Eden | S | S |  Old  |     Metaspace    | C Heap | Thread |
|      | 0 | 1 |       |                  |        | Stack  |
+------+---+---+-------+------------------+--------+--------+
* Java Heap: JVM이 관리하는 영역
* Native Memory: OS에서 관리하는 영역
```

 Java 7은 `permanet generation` 영역이 존재하고 Java 8 이후 `permanet generation` 영역은 삭제되고 `metaspace` 영역이 추가된다.

Java7까지의 Permgen(Permanent Generation) 영역은 JVM 관리하는 메모리 영역이였지만 Java8 이후 추가된 Meataspace 영역은 OS에서 관리하는 Native 메모리 영역으로 변경되었다.

### Permanent Generation 와 Metaspace
Permanet Generation과 Metaspace는 간단히 말해 Java의 Classloader가 로드한 Class의 Metadata를 저장하기 위해 Hotspot JVM에서 구현한 Method 영역이다.

#### Permanent Generation
- Permanent Generation는 다음과 같은과 같은 정보를 저장한다.
```
1. Class의 Meta정보 (pkg path 정보라고 보면 됨, text 정보)
2. Method의 Meta 정보
3. Static Object
4. 상수화된 String Object
5. Class와 관련된 배열 객체 Meta 정보
6. JVM 내부적인 객체들과 최적화컴파일러(JIT)의 최적화 정보
```
- Default로 제한된 크기를 갖고 있다.
- Perm 영역은 고정된 사이즈고 Runtime에 사이즈가 확장

#### Metaspace
- Metaspace는 간단히 말해 Java의 Classloader가 로드한 class들의 metadata가 저장되는 공간이다.
- Metaspace는 Permgen과 달리 Heap 영역이 아닌 Native Memory 영역에 위치한다.
- Default로 제한된 크기를 가지고 있지 않다. 그래서 필요한 만큼 계속 늘어난다.
- 참고로 Metaspace는 아래와 같은 용어들과 혼용되어 쓰이기도 한다:
Native Area, Native Memory, Off-Heap, Non-heap, Direct Memory 등

#### 변경된 사항
- class meta-data는 native memory로 이동된 Metaspace에 저장하고 permanent에 저장했던 interned strings와 static 변수는 heap 영역으로 보내짐

|                          | Java 7                                | Java 8                                          |
| ------------------------ | ------------------------------------- | ----------------------------------------------- |
| Class 메타 데이터        | 저장                                  | 저장                                            |
| Method 메타 데이터       | 저장                                  | 저장                                            |
| Static Object 변수, 상수 | 저장                                  | Heap 영역으로 이동                              |
| 메모리 튜닝              | Heap, Perm 영역 튜닝                  | Heap 튜닝, Native 영역은 OS가 동적 조정         |
| 메모리 옵션              | `-XX:PermSize`  <br>`-XX:MaxPermSize` | `-XX:MetaspaceSize`  <br>`-XX:MaxMetaspaceSize` |

- PermGen에 속한 Method area가 클래스 변수를 저장한다고 알고 있다면 이해하기 쉽지 않다. static 변수는 클래스 변수로 명시적 null 선언이 되지 않으면 gc되어서는 안되는 변수다. Method area가 클래스 변수를 저장한다고 이해하는 시점에서 오해가 발생한다 Method area는 class의 meat-data를 저장할 뿐 실질적인 객체와 데이터는 Method area 바깥의 PermGen에 저장됨을 알아야 한다.

#### Permanent Genration이 Metaspace로 바뀐 이유
- Permanet Genration은 JVM이 관리하는 영역이라 사이즈 제한이 있었다. Metaspace가 Native 메모리를 이용함으로서 개발자는 영역 확보의 상한을 크게 의식할 필요가 없어지게 되었다. 즉, 각종 메타 정보를 OS가 관리하는 영역으로 옮겨 Perm 영역의 사이즈 제한을 없앤 것